<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Making Cleaner NASM Code with Macros &middot; Cogs and Levers
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body>

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p>A place for thoughts, ideas, tutorials and bookmarks. My brain can only hold so much, you know.</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/">Home</a>

    

    
    
      
        
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    

    <a class="sidebar-nav-item" href="https://github.com/tuttlem/tuttlem.github.io">GitHub</a>
  </nav>

  <div class="sidebar-item">
    <p>
      &copy; 2014. All rights reserved.
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <label for="sidebar-checkbox" class="sidebar-toggle"></label>

          <h3 class="masthead-title">
            <a href="/" title="Home">Cogs and Levers</a>
            <small>A blog full of technical stuff</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="post">
  <h1 class="post-title">Making Cleaner NASM Code with Macros</h1>
  <span class="post-date">09 Jan 2013</span>
  <h1>Making Cleaner NASM Code with Macros</h1>
<div class='post'>
<h3>Introduction</h3><div>Cleaner, clearer code is better. It's easier to debug, it's easier to read, it's just plain - better. Assembly code isn't known for its ability to allow the developer to make their intentions clear in its source code, but we can get closer with some carefully craft macros.</div><div><br /></div><div>Macros are symbols that you can use in your code to represent a block of code. Macros are allowed to take parameters which makes them an extremely flexible and valuable tool in your arsenal. These symbols that you use in your code are swapped out by nasm at the time of assembly for the blocks of code that they represent.</div><div><br /></div><div>If you want to go further in depth to the nasm pre-processor and macros, check it out in the manual <a href="http://www.nasm.us/doc/nasmdoc4.html">here</a>.</div><div><br /></div><div>Today's post will be focused on cleaning up the code that we'd written in <a href="http://cogsandlevers.blogspot.com.au/2013/01/strlen-implementation-in-nasm.html">this</a> previous article to look a little more human.</div><div><br /></div><h3>Revisiting write and strlen</h3><div>In the previous article "<a href="http://cogsandlevers.blogspot.com.au/2013/01/strlen-implementation-in-nasm.html">strlen() implementation in NASM</a>", we'd put together a couple of ways to take the length of a string. This article will assume that we're already using this code. With this in mind, we can put together a general purpose print function that will display a zero terminated string with the following.</div><div><br /><script src="https://gist.github.com/4492430.js"></script></div><div><br /></div><div><br /></div><div>Ok, that's a nice and neat little bundle. Now, everytime that we want to call this function, we need to write code that looks like the following.<br /><br /><script src="https://gist.github.com/4492450.js"></script></div><div><br />Which, isn't too bad I guess. We can make it look better though. Consider the following code that wraps this code into a macro.<br /><br /><script src="https://gist.github.com/4492469.js"></script> <br />The syntax here may look a little alien to begin with, but it'll all make sense in a minute. So, we start the macro block off with a "%macro" directive. What follows is the name of the macro, in this case "print" and after that is the number of parameters that this macro will expect (we want one parameter, being the string to print). We have the print code between the directives. You'll see that rdi gets loaded with "%1" which just means "replace %1 with the first thing passed to this macro". To finish up your macro, you have "%endmacro".<br /><br />With that macro defined, you can now print a message to screen by doing this.<br /><br /><script src="https://gist.github.com/4492503.js"></script> <br />This is starting to look a little higher-level now. A bit more "human" on the eyes.<br /><br />Another nifty trick that I'd picked up a while ago was a macro for defining strings. In all of the examples we've seen so far, you'd declare strings in the data segment with the following syntax.<br /><br /><script src="https://gist.github.com/4492529.js"></script> <br />This is perfectly fine, however we can wrap this string declaration up into a macro of its own as well allowing us to define strings where ever we are. We need to be careful though. Defining a string in the code segment without the appropriate jumps is dangerous as we run the risk of executing the string data. The following macro does this safely.<br /><br /><script src="https://gist.github.com/4492549.js"></script> You can see that we've declared a macro that expects two parameters. The first parameter is the name of the variable that we declare. This name is also used to formulate the labels that we jump to so that they are unique between string definitions. The second parameter is the actual string data itself.<br /><br />Now that we have both of these macros defined, the following code is perfectly legal and works a treat.<br /><br /><script src="https://gist.github.com/4492568.js"></script> <br />Well, this is only the start of what you can accomplish with macros. An exercise to the reader would be to implement your own version of "print" that prints a new line after it prints the string - you never know, you might even want to call it "println"!<br /><br />Enjoy.</div></div>
<h2>Comments</h2>
<div class='comments'>
</div>

</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2014/03/25/assembly-syntax-intel-at-t/">
            Assembly Syntax Intel At T
            <small>25 Mar 2014</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2014/03/24/xargs-i/">
            xargs -i
            <small>24 Mar 2014</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2014/03/19/a-quick-lap-with-mvar/">
            A Quick Lap with MVar
            <small>19 Mar 2014</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

      </div>
    </div>

  </body>
</html>
