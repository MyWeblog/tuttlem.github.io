<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Cogs and Levers &middot; A blog full of technical stuff
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body>

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p>A place for thoughts, ideas, tutorials and bookmarks. My brain can only hold so much, you know.</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/">Home</a>

    

    
    
      
        
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    

    <a class="sidebar-nav-item" href="https://github.com/tuttlem/tuttlem.github.io">GitHub</a>
  </nav>

  <div class="sidebar-item">
    <p>
      &copy; 2014. All rights reserved.
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <label for="sidebar-checkbox" class="sidebar-toggle"></label>

          <h3 class="masthead-title">
            <a href="/" title="Home">Cogs and Levers</a>
            <small>A blog full of technical stuff</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2012/11/30/plan-9/">
        Plan 9
      </a>
    </h1>

    <span class="post-date">30 Nov 2012</span>

    <h1>Plan 9</h1>
<div class='post'>
Bell Labs look like they've just opened up a little more of their source-code in the shape of some system commands.<br /><span style="font-family: inherit;"><br /><a href="http://plan9.bell-labs.com/sources/plan9/sys/src/">http://plan9.bell-labs.com/sources/plan9/sys/src/</a></span><br /><span style="font-family: inherit;"><a href="http://plan9.bell-labs.com/sources/plan9/sys/src/cmd/">http://plan9.bell-labs.com/sources/plan9/sys/src/cmd/</a></span><br /><br />It's worth a browse just to have a look at how some of these things were implemented.<br /><br />A quick update, seems that someone has Plan9 running on a raspberry PI.<br /><br /><span style="background-color: white; color: #1155cc; font-family: inherit;"><a href="http://bendyworks.com/geekville/lab_projects/2012/11/getting-plan-9-running-on-the-raspberry-pi" style="background-color: white; color: #1155cc;" target="_blank">http://bendyworks.com/<wbr></wbr>geekville/lab_projects/2012/<wbr></wbr>11/getting-plan-9-running-on-<wbr></wbr>the-raspberry-pi</a></span><br /><br /></div>
<h2>Comments</h2>
<div class='comments'>
</div>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2012/11/29/simple-random-number-generation-with-masm32/">
        Simple random number generation with MASM32
      </a>
    </h1>

    <span class="post-date">29 Nov 2012</span>

    <h1>Simple random number generation with MASM32</h1>
<div class='post'>
Here's a little tid-bit that I'd like to make note of. In a previous MASM32 windows development tutorial, I needed a random number generator and was able to dig this one up from the archivies.<br /><div><br /></div><div>First of all, you need to make sure we're using the 586 instruction set - at least!</div><div><br /><script src="https://gist.github.com/4164886.js?file=gistfile1.asm"></script></div><div><br /></div><div>Shortly, it will become clear why we need the 586 instruction set.<br /><br />To support the random number generator, we need a bit of state in the shape of two double-words.<br /><br /><script src="https://gist.github.com/4164897.js?file=gistfile1.asm"></script> <br /><br /></div><div>These two variables allow the random number generator to know where it's up to for the next iteration. Changing the initial seed of course will change the sequence of random values that are produced by this routine.<br /><br />The actual function that produces the random number look like this:<br /><br /><script src="https://gist.github.com/4164970.js?file=gistfile1.asm"></script> <br />There it is. That first instruction <a href="http://ref.x86asm.net/coder32-abc.html#R">RDTSC</a>&nbsp;is what we need to turn the 586 instruction set on for. This&nbsp;mnemonic stands for&nbsp;&nbsp;Read Time-Stamp Counter. It will take the number of cycles since the machine has been reset and put this count into the EDX:EAX pair (as the time stamp counter is a 64bit value).<br /><br />From there some calculations are performed to ensure the consistency of state between random value retrieves and also capping to the requested range.<br /><br />Simple and it works too!</div></div>
<h2>Comments</h2>
<div class='comments'>
</div>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2012/11/29/mode-x-plus-some/">
        Mode X.. plus some!
      </a>
    </h1>

    <span class="post-date">29 Nov 2012</span>

    <h1>Mode X.. plus some!</h1>
<div class='post'>
So, not much of tutorial here - just a neat layout of setup code for a few mode X modes I've come across now and then.<br /><br />First of all, just some formalities. Setting Mode X tweaks to the VGA is a massive port-out exercise. Creating the following macro cut down on my code heaps.<br /><br /><script src="https://gist.github.com/4168905.js?file=gistfile1.asm"></script> <br />So you can see, &nbsp;it just gives sending a byte out to a port a bit of syntactical sugar in assembly language. Easy.<br /><br />The only other piece of formality is, you must have set the video display into MCGA (mode 13) first:<br /><br /><script src="https://gist.github.com/4168969.js?file=gistfile1.asm"></script> <br />On to the modes.<br /><br /><script src="https://gist.github.com/4168909.js?file=gistfile1.asm"></script> <script src="https://gist.github.com/4168920.js?file=gistfile1.asm"></script> <script src="https://gist.github.com/4168932.js?file=gistfile1.asm"></script> <script src="https://gist.github.com/4168936.js?file=gistfile1.asm"></script> <script src="https://gist.github.com/4168939.js?file=gistfile1.asm"></script> <script src="https://gist.github.com/4168949.js?file=gistfile1.asm"></script> <script src="https://gist.github.com/4168963.js?file=gistfile1.asm"></script> <br /><br />I will have an update to this post. There are some nuances that I'd much prefer explain to you with a couple of nice code blocks rather than how I'm just going to throw it into the page.<br /><br />These chunks will be helpful in page selection and optimizing page draws to multiple pages at once.<br /><br /><br /><pre class="brush:plain;"> ; setting a page<br /> ; activeOffset = vgapage + (page * pageSize / 4);<br /> <br /> ; enable all planes<br /> ; outp 03c4h, 02h<br /> ; outp 03c5h, 0fh<br /></pre><br />Some really good references on this topic are<br /><br />Mode X on Wikipedia<br /><a href="http://en.wikipedia.org/wiki/Mode_X">http://en.wikipedia.org/wiki/Mode_X</a><br /><br />Bob Pendleton's Mode X Tutorial<br /><a href="http://www.gameprogrammer.com/3-tweak.html">http://www.gameprogrammer.com/3-tweak.html</a> <br /><br />Well, that's it for now.</div>
<h2>Comments</h2>
<div class='comments'>
</div>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2012/11/28/windows-development-with-masm32-part-4/">
        Windows Development with MASM32 (part 4)
      </a>
    </h1>

    <span class="post-date">28 Nov 2012</span>

    <h1>Windows Development with MASM32 (part 4)</h1>
<div class='post'>
<h3>Introduction</h3><div>Welcome to the fourth instalment in this windows development series. Just to re-cap the story so far, we've:</div><div><ul><li><a href="http://cogsandlevers.blogspot.com.au/2012/11/windows-development-with-masm32-part-1.html">Displayed a message box to the screen</a> in part 1</li><li><a href="http://cogsandlevers.blogspot.com.au/2012/11/windows-development-with-masm32-part-2.html">Setup a message pump</a> in part 2</li><li><a href="http://cogsandlevers.blogspot.com.au/2012/11/windows-development-with-masm32-part-3.html">Created a basic window</a> in part 3</li></ul><div>It's time to try something a little fun and little out of the tutorial mould that you'd be expecting at part 4. Today, lets create a window and setup a double buffer to provide flicker-free animation into our windows applications.</div></div><div><br /></div><div>This is going to be of great use if we want to do our own custom drawing without employing DirectX or OpenGL. Most of all, it'll be a laugh getting there.</div><h3>Double buffer theory, GDI style</h3><div>In a generic sense, we manage a block of memory (away from the visible video memory) that has the same characteristics (width, height and depth) as the screen we're presenting. We perform all of our drawing within this off-screen memory buffer and then "flip" it over onto the presenting video memory when we're ready to show it.</div><div><br /></div><div>In GDI land, this procedure is split between a <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa383751(v=vs.85).aspx">HDC</a>&nbsp;and a <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa383751(v=vs.85).aspx">HBITMAP</a>. A&nbsp;<a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa383751(v=vs.85).aspx">HDC</a>&nbsp;is obtained so that we have an access context into allocated memory. This is also what we'll use when we go to draw something. Where it's stored is in the bitmap.&nbsp;A&nbsp;<a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa383751(v=vs.85).aspx">HBITMAP</a>&nbsp;is obtained so that we can match what is being presented to the user in video memory. Windows does a good job of copying these characteristics when we call <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/dd183488(v=vs.85).aspx">CreateCompatibleBitmap</a>.</div><h3>Supporting the back-buffer</h3><div>So, we need a couple of functions in order to keep the backbuffer happy when the window changes. We need to react when Windows tells us something about the window. In this scenario, we're going to be very interested in the resize message (<a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms632646(v=vs.85).aspx">WM_SIZE</a>). We need to teardown any already setup back buffer, create a new one of adequate size and continue on.</div><div><br /></div><div>Let's take a look at the code that's will create and re-create our back-buffer when requested.</div><div><br /><script src="https://gist.github.com/4161317.js?file=gistfile1.asm"></script></div><div><br /></div><div><a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms633503(v=vs.85).aspx">GetClientRect</a> fills out a <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa383751(v=vs.85).aspx">RECT</a> structure for us with the client dimensions of the window. This is perfect to give us the dimensions for the back buffer. <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/dd144871(v=vs.85).aspx">GetDC</a> obtains a device context directly on the window for us and we use this&nbsp;<a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa383751(v=vs.85).aspx">HDC</a>&nbsp;in order to create an in-memory representation using <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/dd183489(v=vs.85).aspx">CreateCompatibleDC</a>. Now that we know what we'll end up drawing to, we just need a buffer off-screen that will hold our intermediate frame. We do this by using&nbsp;<a href="http://msdn.microsoft.com/en-us/library/windows/desktop/dd183488(v=vs.85).aspx">CreateCompatibleBitmap</a>.<br /><br />You'll see a reference to the teardown for the backbuffer in the creation procedure. It's all about safety making sure we're un allocated before trying again. Here's that teardown.<br /><br /><script src="https://gist.github.com/4161329.js?file=gistfile1.asm"></script> <br /><br /></div><div>Tearing down is really just use of <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/dd183539(v=vs.85).aspx">DeleteObject</a> and <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/dd162920(v=vs.85).aspx">ReleaseDC</a> calls. This is fairly straight forward.<br /><br />Finally, we need to be able to send the back buffer to the front (visible) buffer. This flip method using GDI calls is how we accomplish that.<br /><br /><script src="https://gist.github.com/4161348.js?file=gistfile1.asm"></script> <br />A point to note here is the use of <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/dd183370(v=vs.85).aspx">BitBlt</a>. We need a way to quickly copy everything on the back buffer to everything on the front buffer. <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/dd183370(v=vs.85).aspx">BitBlt</a> is purpose built to work on copying bitmaps between&nbsp;<a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa383751(v=vs.85).aspx">HDC</a>'s so this is the natural choice.<br /><h3>Not a normal message pump</h3></div><div>The type of application has changed. We're now targeting an animating, constantly re-drawn application that needs a new style of message pump. The last type of message pump was very passive, only doing something when required. This new one is very active - peeking the message stack using <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms644943(v=vs.85).aspx">PeekMessage</a>&nbsp;to determine if messages need to be processed, otherwise re-drawing the application.</div><div><br /></div><div>Here's the message pump for the application.</div><div><br /><script src="https://gist.github.com/4161383.js?file=gistfile1.asm"></script></div><div><br /></div><div><br /></div><div>Finally, we have the window procedure. This is what will co-ordinate the destruction and re-creation of the back buffer when catastrophic changes occur to the visual appearance of the application.<br /><br /><script src="https://gist.github.com/4161428.js?file=gistfile1.asm"></script> <br />That's about it for the double-buffer side of things. The rest of the application itself does have some trickery behind drawing random shapes, but I'll leave the random number generator for a later post.<br /><br />Get double buffering!</div></div>
<h2>Comments</h2>
<div class='comments'>
</div>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2012/11/27/offscreen-mesa3d/">
        Offscreen Mesa3D
      </a>
    </h1>

    <span class="post-date">27 Nov 2012</span>

    <h1>Offscreen Mesa3D</h1>
<div class='post'>
As a quick bookmark, this part of the Mesa3D project: <a href="http://www.mesa3d.org/osmesa.html">Off-screen Rendering</a>&nbsp;looks like it might be a viable option for some of the lower-end hardware I've come across lately.<br /><br />Bisqwit seems to have made pretty decent use of it in one of his videos here<br /><br /><br /><iframe width="420" height="315" src="http://www.youtube.com/embed/vkUwT9U1GzA" frameborder="0" allowfullscreen></iframe><br />Interesting.</div>
<h2>Comments</h2>
<div class='comments'>
</div>

  </div>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page38">Older</a>
  
  
    
      <a class="pagination-item newer" href="/page36">Newer</a>
    
  
</div>
      </div>
    </div>

  </body>
</html>
