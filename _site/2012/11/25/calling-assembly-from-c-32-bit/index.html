<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Calling Assembly from C (32 bit) &middot; Cogs and Levers
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body>

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p>A place for thoughts, ideas, tutorials and bookmarks. My brain can only hold so much, you know.</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/">Home</a>

    

    
    
      
        
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    

    <a class="sidebar-nav-item" href="https://github.com/tuttlem/tuttlem.github.io">GitHub</a>
  </nav>

  <div class="sidebar-item">
    <p>
      &copy; 2014. All rights reserved.
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <label for="sidebar-checkbox" class="sidebar-toggle"></label>

          <h3 class="masthead-title">
            <a href="/" title="Home">Cogs and Levers</a>
            <small>A blog full of technical stuff</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="post">
  <h1 class="post-title">Calling Assembly from C (32 bit)</h1>
  <span class="post-date">25 Nov 2012</span>
  <p>One of the biggest advantages of being able to write assembly code is to optimise any bits of your application that you want. That way you can maintain your code base in a half-sane language (like C) and roll your sleeves up to speed up the smaller parts that you want.</p>

<p>This blog post will show you how to call a routine that you&#39;ve defined in assembly language from your C code. The example that I&#39;ll show has been done in a Linux environment using <a href="http://www.nasm.us/">NASM</a> as the assembler and <a href="http://gcc.gnu.org/">GCC</a> for the C compiler.</p>

<p>First of all, let&#39;s write our C program. This will simply add two integers and output the results using <a href="http://pubs.opengroup.org/onlinepubs/009695399/functions/printf.html">printf</a>.</p>

<div class="highlight"><pre><code class="c"><span class="cp">#include &lt;stdio.h&gt;</span>

<span class="cm">/** Forward declaration for our add function */</span>
<span class="kt">int</span> <span class="nf">add</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>

   <span class="cm">/* add some numbers */</span>
   <span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

   <span class="cm">/* print the result out */</span>
   <span class="n">printf</span><span class="p">(</span><span class="s">&quot;5+4=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>

   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></code></pre></div>

<p>There isn&#39;t anything of great interest in here. We have a forward declaration for our add function. That&#39;s about it. Now we have to supply an implementation for our add routine. For this we&#39;ll be using assembly language.</p>

<div class="highlight"><pre><code class="nasm"><span class="k">global</span> <span class="nv">add</span>

<span class="k">section</span> <span class="nv">.text</span>

<span class="nl">add:</span>
   <span class="nf">mov</span>   <span class="nb">eax</span><span class="p">,</span> <span class="p">[</span><span class="nb">esp</span><span class="o">+</span><span class="mi">4</span><span class="p">]</span>    <span class="c1">; get the 1st param</span>
   <span class="nf">mov</span>   <span class="nb">ecx</span><span class="p">,</span> <span class="p">[</span><span class="nb">esp</span><span class="o">+</span><span class="mi">8</span><span class="p">]</span>    <span class="c1">; get the 2nd param</span>
   <span class="nf">add</span>   <span class="nb">eax</span><span class="p">,</span> <span class="nb">ecx</span>        <span class="c1">; add them together</span>
                         <span class="c1">; leaving the return value in eax</span>

   <span class="nf">ret</span></code></pre></div>

<p>This is all pretty straight forward. We define a symbol &quot;add&quot; as global. In the code (or .text) section, we supply an implementation for it. The trickiest part here is being able to retrieve parameters that are passed in from the C level. You can see that we&#39;re addressing stack pointer to do so. </p>

<p>Add takes two parameters. In this scenario (c-calling convention) the parameters to the function are pushed onto the stack in reverse order. So, the second parameter goes onto the stack first and then the first. Once all of the pushing has complete, the first parameter is at <code>[esp+4]</code> and the second is at <code>[esp+8]</code>. Remember - an integer (on this architecture) has 4 bytes (32 bits).</p>

<p>Return values are always left in <code>eax</code>. You&#39;ll see that after the arithmetic completes, it&#39;ll be <code>eax</code> that holds the answer. It&#39;s what will be given back to the caller.</p>

<p>Finally, all we need to do is compile these files and link together their object files. We do this from the Linux console with the following commands.</p>

<div class="highlight"><pre><code class="bash">gcc -m32 -c -g add.c -o add.o
nasm -felf32 maths.asm -o maths.o
gcc -m32 add.o maths.o -o add</code></pre></div>

<p>We&#39;re done. I&#39;ll be doing another one of these sorts of blog posts shortly demonstrating how we&#39;ll do this in the 64-bit arena.</p>

</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2014/03/25/assembly-syntax-intel-at-t/">
            Assembly Syntax Intel At T
            <small>25 Mar 2014</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2014/03/24/xargs-i/">
            xargs -i
            <small>24 Mar 2014</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2014/03/19/a-quick-lap-with-mvar/">
            A Quick Lap with MVar
            <small>19 Mar 2014</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

      </div>
    </div>

  </body>
</html>
