<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Cogs and Levers &middot; A blog full of technical stuff
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body>

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p>A place for thoughts, ideas, tutorials and bookmarks. My brain can only hold so much, you know.</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/">Home</a>

    

    
    
      
        
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    

    <a class="sidebar-nav-item" href="https://github.com/tuttlem/tuttlem.github.io">GitHub</a>
  </nav>

  <div class="sidebar-item">
    <p>
      &copy; 2014. All rights reserved.
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <label for="sidebar-checkbox" class="sidebar-toggle"></label>

          <h3 class="masthead-title">
            <a href="/" title="Home">Cogs and Levers</a>
            <small>A blog full of technical stuff</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2012/11/25/unix-ipc-memory-mapped-files/">
        Unix Ipc Memory Mapped Files
      </a>
    </h1>

    <span class="post-date">25 Nov 2012</span>

    <p>This snippet will show you how to open a file and map it into memory.</p>

<div class="highlight"><pre><code class="c"><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="n">pagesize</span><span class="p">;</span>
<span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
 
<span class="cm">/* open the file */</span>
<span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">&quot;somefile&quot;</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
 
<span class="cm">/* get the current page size */</span>
<span class="n">pagesize</span> <span class="o">=</span> <span class="n">getpagesize</span><span class="p">();</span>
 
<span class="cm">/* map the 2nd page into memory */</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">((</span><span class="kt">caddr_t</span><span class="p">)</span><span class="mi">0</span><span class="p">,</span> <span class="n">pagesize</span><span class="p">,</span> <span class="n">PROT_READ</span><span class="p">,</span> <span class="n">MAP_SHARED</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">pagesize</span><span class="p">);</span>
                                                        
<span class="cm">/* start using the data pointer */</span></code></pre></div>

<h3 id="further-reading">Further reading</h3>

<p><a href="http://unixhelp.ed.ac.uk/CGI/man-cgi?mmap">The mmap system call</a></p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2012/11/25/unix-ipc-locking-files/">
        Unix Ipc Locking Files
      </a>
    </h1>

    <span class="post-date">25 Nov 2012</span>

    <p>Locking a file helps assure your program that no other processes can tamper with it or a region of it.</p>

<p>This snippet will show you how to lock and unlock a file.struct flock fl;
int fd;</p>

<div class="highlight"><pre><code class="c"><span class="cm">/* fill out the lock structure */</span>   
<span class="n">fl</span><span class="p">.</span><span class="n">l_type</span>   <span class="o">=</span> <span class="n">F_WRLCK</span><span class="p">;</span> 
<span class="n">fl</span><span class="p">.</span><span class="n">l_whence</span> <span class="o">=</span> <span class="n">SEEK_SET</span><span class="p">;</span>
<span class="n">fl</span><span class="p">.</span><span class="n">l_start</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>       
<span class="n">fl</span><span class="p">.</span><span class="n">l_len</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>       
<span class="n">fl</span><span class="p">.</span><span class="n">l_pid</span>    <span class="o">=</span> <span class="n">getpid</span><span class="p">();</span>
 
<span class="cm">/* open the file */</span>
<span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">&quot;filename&quot;</span><span class="p">,</span> <span class="n">O_WRONLY</span><span class="p">);</span>
 
<span class="cm">/* lock the file */</span>
<span class="n">fcntl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">F_SETLKW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fl</span><span class="p">);</span>
 
<span class="cm">/* --- complete any work here with the file locked --- */</span>
 
<span class="cm">/* unlock the file now */</span>
<span class="n">fl</span><span class="p">.</span><span class="n">l_type</span>   <span class="o">=</span> <span class="n">F_UNLCK</span><span class="p">;</span> 
<span class="n">fcntl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">F_SETLK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fl</span><span class="p">);</span></code></pre></div>

<h3 id="further-reading">Further reading</h3>

<p><a href="http://unixhelp.ed.ac.uk/CGI/man-cgi?fcntl">The fcntl system call</a></p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2012/11/25/unix-ipc-forking-and-waiting/">
        Unix Ipc Forking And Waiting
      </a>
    </h1>

    <span class="post-date">25 Nov 2012</span>

    <p>In order to create processes within the Unix environment, you must fork. Forking a process establishes the parent / child relationship which is where the waiting comes into it. All good parents wait for their children to die before terminating.</p>

<p>It&#39;s just good manners, you know?</p>

<p>So, the snippet for this will be a fork and wait set:</p>

<div class="highlight"><pre><code class="c"><span class="cm">/* fork execution here */</span>
<span class="kt">pid_t</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">();</span>
 
<span class="kt">int</span> <span class="n">child_exit_code</span><span class="p">;</span>
 
<span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
 <span class="cm">/* -1 indicates that fork failed */</span>
 <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
 <span class="cm">/* 0 indicates that this is the child process */</span>
 <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
 <span class="cm">/* the pid being returned indicates it&#39;s the parent */</span>
 <span class="cm">/* wait for the child to finish and</span>
<span class="cm">    capture its exit code */</span>
 <span class="n">wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">child_exit_code</span><span class="p">);</span>
<span class="p">}</span></code></pre></div>

<h3 id="further-reading">Further reading</h3>

<p><a href="http://unixhelp.ed.ac.uk/CGI/man-cgi?fork+2">The fork system call</a>
<a href="http://unixhelp.ed.ac.uk/CGI/man-cgi?wait+2">The wait system call</a></p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2012/11/25/calling-assembly-from-c-32-bit/">
        Calling Assembly from C (32 bit)
      </a>
    </h1>

    <span class="post-date">25 Nov 2012</span>

    <p>One of the biggest advantages of being able to write assembly code is to optimise any bits of your application that you want. That way you can maintain your code base in a half-sane language (like C) and roll your sleeves up to speed up the smaller parts that you want.</p>

<p>This blog post will show you how to call a routine that you&#39;ve defined in assembly language from your C code. The example that I&#39;ll show has been done in a Linux environment using <a href="http://www.nasm.us/">NASM</a> as the assembler and <a href="http://gcc.gnu.org/">GCC</a> for the C compiler.</p>

<p>First of all, let&#39;s write our C program. This will simply add two integers and output the results using <a href="http://pubs.opengroup.org/onlinepubs/009695399/functions/printf.html">printf</a>.</p>

<div class="highlight"><pre><code class="c"><span class="cp">#include &lt;stdio.h&gt;</span>

<span class="cm">/** Forward declaration for our add function */</span>
<span class="kt">int</span> <span class="nf">add</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>

   <span class="cm">/* add some numbers */</span>
   <span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

   <span class="cm">/* print the result out */</span>
   <span class="n">printf</span><span class="p">(</span><span class="s">&quot;5+4=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>

   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></code></pre></div>

<p>There isn&#39;t anything of great interest in here. We have a forward declaration for our add function. That&#39;s about it. Now we have to supply an implementation for our add routine. For this we&#39;ll be using assembly language.</p>

<div class="highlight"><pre><code class="nasm"><span class="k">global</span> <span class="nv">add</span>

<span class="k">section</span> <span class="nv">.text</span>

<span class="nl">add:</span>
   <span class="nf">mov</span>   <span class="nb">eax</span><span class="p">,</span> <span class="p">[</span><span class="nb">esp</span><span class="o">+</span><span class="mi">4</span><span class="p">]</span>    <span class="c1">; get the 1st param</span>
   <span class="nf">mov</span>   <span class="nb">ecx</span><span class="p">,</span> <span class="p">[</span><span class="nb">esp</span><span class="o">+</span><span class="mi">8</span><span class="p">]</span>    <span class="c1">; get the 2nd param</span>
   <span class="nf">add</span>   <span class="nb">eax</span><span class="p">,</span> <span class="nb">ecx</span>        <span class="c1">; add them together</span>
                         <span class="c1">; leaving the return value in eax</span>

   <span class="nf">ret</span></code></pre></div>

<p>This is all pretty straight forward. We define a symbol &quot;add&quot; as global. In the code (or .text) section, we supply an implementation for it. The trickiest part here is being able to retrieve parameters that are passed in from the C level. You can see that we&#39;re addressing stack pointer to do so. </p>

<p>Add takes two parameters. In this scenario (c-calling convention) the parameters to the function are pushed onto the stack in reverse order. So, the second parameter goes onto the stack first and then the first. Once all of the pushing has complete, the first parameter is at <code>[esp+4]</code> and the second is at <code>[esp+8]</code>. Remember - an integer (on this architecture) has 4 bytes (32 bits).</p>

<p>Return values are always left in <code>eax</code>. You&#39;ll see that after the arithmetic completes, it&#39;ll be <code>eax</code> that holds the answer. It&#39;s what will be given back to the caller.</p>

<p>Finally, all we need to do is compile these files and link together their object files. We do this from the Linux console with the following commands.</p>

<div class="highlight"><pre><code class="bash">gcc -m32 -c -g add.c -o add.o
nasm -felf32 maths.asm -o maths.o
gcc -m32 add.o maths.o -o add</code></pre></div>

<p>We&#39;re done. I&#39;ll be doing another one of these sorts of blog posts shortly demonstrating how we&#39;ll do this in the 64-bit arena.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2012/11/24/pretty-code-is-readable-code/">
        Pretty code is readable code
      </a>
    </h1>

    <span class="post-date">24 Nov 2012</span>

    <p>There&#39;s no doubt about it. Syntax highlighting in code is the cornerstone of readability (in my mind anyway). I was browsing around today and found an assembly language highlighter for visual studio <a href="http://asmhighlighter.codeplex.com">here</a>.</p>

<p>Now my code looks like this (inside of VS).</p>

<p><img src="http://1.bp.blogspot.com/-anD4yrKLxDE/ULAke-WtJsI/AAAAAAAAAhA/gNxQirJQAaU/s400/Screen+Shot+2012-11-24+at+11.35.06+AM.png" alt="Screen shot"></p>

  </div>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page42">Older</a>
  
  
    
      <a class="pagination-item newer" href="/page40">Newer</a>
    
  
</div>
      </div>
    </div>

  </body>
</html>
